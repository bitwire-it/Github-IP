name: Get and Save GitHub IPs

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write

jobs:
  get_and_commit_ips:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Fetch and Filter GitHub Meta IPs
        shell: bash
        run: |
          # Fetch data, process with jq, and write directly to the file
          # We use curl -fsSL to fail on error and follow redirects
          curl -fsSL "https://api.github.com/meta" | jq -r '
            . | 
            {
              hooks: .hooks, 
              web: .web, 
              api: .api, 
              git: .git, 
              github_enterprise_importer: .github_enterprise_importer,
              packages: .packages,
              pages: .pages,
              importer: .importer
            } |
            flatten |
            map(select(. | test("^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}(\\/\\d{1,2})?$"))) | 
            sort |
            unique |
            .[]
          ' > github_ip_list.txt
          
          # Debug output to verify content length in logs
          echo "Generated IP list with $(wc -l < github_ip_list.txt) entries."

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Automated update of GitHub IP list
          file_pattern: github_ip_list.txt
          # The action automatically handles "No changes to commit" scenarios
